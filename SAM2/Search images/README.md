# 图像相似度比较工具

这个项目提供了多种方法来比较图像相似度，帮您找到与目标图片最相似的图片。**新增角度校正功能**，可以自动检测并校正图片角度，提高相似度比较的准确性。

## 📁 文件说明

- `find_similar_image.py` - 完整版本，支持多种算法并自动运行所有方法
- `simple_similarity.py` - 简化版本，可以选择单个方法运行
- `optimized_image_similarity.py` - 面向对象版本，功能最全面
- `angle_corrected_similarity.py` - **新增**：带角度校正的完整版本
- `simple_angle_correction.py` - **新增**：带角度校正的简化版本
- `opencv_hash.py` - 原始的简单哈希比较代码
- `requirements.txt` - 依赖包列表

## 🔧 安装依赖

在运行脚本之前，请先安装必要的依赖包：

```bash
pip install -r requirements.txt
```

或者手动安装：

```bash
pip install opencv-python Pillow imagehash numpy scikit-image matplotlib
```

### 🔥 使用SURF特征（可选）

如果您想使用SURF特征匹配，需要安装包含额外算法的OpenCV版本：

```bash
# 卸载标准版本
pip uninstall opencv-python

# 安装包含SURF的版本
pip install opencv-contrib-python
```

**注意**: SURF算法受专利保护，仅供学术研究使用。商业用途请使用SIFT或ORB算法。

### 🧠 使用ResNet50深度学习特征（推荐）

如果您想使用ResNet50深度学习特征进行语义相似度比较，需要安装PyTorch：

```bash
# 安装PyTorch和TorchVision
pip install torch torchvision

# 或者安装CPU版本（如果不需要GPU加速）
pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
```

**优势**: ResNet50能够理解图像的语义内容，即使外观差异较大也能识别相似的物体和场景。

**测试安装**: 运行测试脚本验证PyTorch安装：
```bash
python test_resnet50.py
```

## 🚀 使用方法

### 方法1: 运行带角度校正的版本（推荐）

```bash
python simple_angle_correction.py
```

这会自动检测并校正图片角度，然后进行相似度比较，并显示校正过程。

### 方法2: 运行完整的角度校正版本

```bash
python angle_corrected_similarity.py
```

支持多种算法 + 角度校正，功能最全面。

### 方法3: 运行普通版本

```bash
python find_similar_image.py
```

不包含角度校正，使用4种不同的方法分析图像相似度。

### 方法4: 运行简化版本

```bash
python simple_similarity.py
```

最基础的版本，可以选择单个算法。

## ⚙️ 配置参数

在脚本中，您可以修改以下参数：

```python
# 目标图片路径
target_image = 'sample1.jpg'

# 搜索文件夹路径
search_folder = 'opt_result/21de6e8046d90a12a59e5017a09b189'

# 相似度计算方法
method = 'sift'  # 可选: 'hash', 'histogram', 'template', 'ssim', 'sift', 'surf', 'orb', 'resnet50', 'combined'

# 角度校正参数（仅在角度校正版本中）
show_correction = True   # 是否显示校正过程
save_corrected = True    # 是否保存校正后的图片
```

## 🔄 角度校正功能

### 工作原理
1. **边缘检测**: 使用Canny算法检测图片边缘
2. **直线检测**: 使用霍夫变换检测主要直线
3. **角度计算**: 分析直线角度，计算需要校正的角度
4. **图片旋转**: 使用仿射变换校正图片角度
5. **相似度比较**: 使用校正后的图片进行相似度计算

### 功能特点
- ✅ 自动检测图片倾斜角度
- ✅ 智能校正图片角度（-45°到+45°范围）
- ✅ 可视化显示校正过程
- ✅ 保存校正后的图片
- ✅ 提高相似度比较准确性

### 校正过程展示
角度校正版本会显示：
- 原始图片
- 边缘检测结果
- 检测到的直线
- 校正后的图片

## 📊 相似度计算方法

### 1. 感知哈希 (Hash)
- **原理**: 计算图像的感知哈希值，通过汉明距离比较
- **优点**: 速度快，对图像缩放、轻微变形不敏感
- **适用**: 检测相同或非常相似的图片
- **输出**: 汉明距离（0=完全相同，越大越不同）

### 2. 直方图比较 (Histogram) ⭐推荐
- **原理**: 比较图像在HSV颜色空间的直方图分布
- **优点**: 对颜色分布敏感，适合检测色彩相似的图片
- **适用**: 检测颜色分布相似的图片
- **输出**: 相关系数（0-1，越大越相似）

### 3. 模板匹配 (Template)
- **原理**: 使用OpenCV的模板匹配算法
- **优点**: 对图像结构和纹理敏感
- **适用**: 检测结构相似的图片
- **输出**: 匹配度（0-1，越大越相似）

### 4. 结构相似度 (SSIM)
- **原理**: 计算结构相似性指数
- **优点**: 更符合人眼视觉感知
- **适用**: 高质量的相似度评估
- **需要**: 安装 scikit-image

### 5. SIFT特征匹配 (SIFT) 🆕
- **原理**: 尺度不变特征变换，检测关键点和描述符
- **优点**: 对旋转、缩放、光照变化具有很强的鲁棒性
- **适用**: 检测相同物体在不同角度、尺度下的图片
- **输出**: 特征匹配相似度（0-1，越大越相似）

### 6. SURF特征匹配 (SURF) 🆕
- **原理**: 加速稳健特征，比SIFT更快的特征检测
- **优点**: 速度比SIFT快，同样具有旋转和尺度不变性
- **适用**: 实时应用中的特征匹配
- **需要**: 安装 opencv-contrib-python
- **输出**: 特征匹配相似度（0-1，越大越相似）

### 7. ORB特征匹配 (ORB) 🆕
- **原理**: 定向FAST和旋转BRIEF，免费的SIFT/SURF替代方案
- **优点**: 速度非常快，免费开源，具有旋转不变性
- **适用**: 需要快速特征匹配的场景
- **输出**: 特征匹配相似度（0-1，越大越相似）

### 8. ResNet50深度学习特征 (ResNet50) 🔥新增
- **原理**: 使用预训练的ResNet50卷积神经网络提取深度特征
- **优点**: 语义理解能力强，能识别图像内容和物体
- **适用**: 检测内容相似的图片，即使外观差异较大
- **需要**: 安装 PyTorch: `pip install torch torchvision`
- **输出**: 余弦相似度（0-1，越大越相似）
- **特点**: 
  - 🧠 基于深度学习，理解图像语义内容
  - 🎯 对物体、场景、概念相似性敏感
  - 🔄 对光照、角度、尺度变化鲁棒
  - ⚡ 首次加载模型较慢，后续计算较快

### 9. 综合方法 (Combined)
- **原理**: 结合多种算法的加权平均（包含ResNet50）
- **权重**: 哈希15% + 直方图20% + 模板10% + SSIM15% + SIFT20% + ResNet50 20%
- **优点**: 更准确，综合考虑多个维度
- **缺点**: 计算时间较长

## 📈 结果解读

### 相似度分数
- **90%以上**: 非常相似
- **70-90%**: 比较相似  
- **50-70%**: 有一定相似性
- **50%以下**: 相似度较低

### 距离/差异度
- **哈希方法**: 汉明距离，0=完全相同，5以下=非常相似
- **其他方法**: 差异度，0=完全相同，越小越相似

### 角度校正信息
- **校正角度**: 显示每张图片检测到的倾斜角度
- **校正状态**: 标识是否进行了角度校正
- **校正效果**: 通过对比图展示校正前后的效果

## 🎯 使用建议

1. **推荐使用角度校正版本**: 特别是当图片可能有旋转时
2. **快速筛选**: 使用哈希方法进行初步筛选
3. **颜色相似**: 使用直方图方法检测色彩相似的图片
4. **结构相似**: 使用模板匹配检测形状结构相似的图片
5. **物体识别**: 使用SIFT特征检测相同物体在不同角度、尺度下的图片
6. **实时应用**: 使用ORB特征进行快速特征匹配
7. **高精度匹配**: 使用SURF特征（需要opencv-contrib-python）
8. **综合评估**: 使用综合方法获得最准确的结果

### 🔍 算法选择指南

| 场景 | 推荐算法 | 特点 |
|------|----------|------|
| 相同图片检测 | Hash | 速度最快 |
| 颜色相似图片 | Histogram | 对颜色敏感 |
| 物体识别 | SIFT | 旋转缩放不变 |
| 实时应用 | ORB | 速度快，免费 |
| 高质量匹配 | SURF | 精度高，需付费版本 |
| 内容语义相似 | ResNet50 | 深度学习，理解图像内容 |
| 综合评估 | Combined | 最准确，速度慢 |

## 📝 示例输出（带角度校正）

```
================================================================================
相似度排行榜 (前10名) - 直方图方法 + 角度校正
================================================================================
排名   相似度      校正角度    图片路径
--------------------------------------------------------------------------------
1    87.7%      -2.3°      opt_result/21de6e8046d90a12a59e5017a09b189/segment_042.png
2    78.4%      1.8°       opt_result/21de6e8046d90a12a59e5017a09b189/segment_031.png
3    71.1%      0.0°       opt_result/21de6e8046d90a12a59e5017a09b189/segment_015.png

🎯 最相似的图片:
  📁 路径: opt_result/21de6e8046d90a12a59e5017a09b189/segment_042.png
  💯 相似度: 87.7%
  🔄 校正角度: -2.3°
```

## 📂 输出文件

运行角度校正版本后，会在 `corrected_images/` 文件夹中保存：
- 校正后的目标图片
- 所有校正后的搜索图片
- 文件命名格式：`原文件名_corrected.扩展名`

## 🔍 故障排除

1. **ModuleNotFoundError**: 请确保安装了所有依赖包
2. **图片无法读取**: 检查图片路径和格式是否正确
3. **文件夹不存在**: 确认搜索文件夹路径正确
4. **SSIM计算失败**: 安装 scikit-image: `pip install scikit-image`
5. **matplotlib显示问题**: 确保安装了matplotlib: `pip install matplotlib`
6. **角度检测不准确**: 可能是图片边缘不够清晰，可以调整Canny参数

## 📞 技术支持

如果遇到问题，请检查：
- Python版本 (建议3.7+)
- 依赖包版本是否兼容
- 图片文件是否损坏
- 文件路径是否正确
- 图片是否有足够的边缘特征用于角度检测 